<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wind Warning - Alerte AutomatezƒÉ de V√¢nt</title>
    <meta name="description" content="Alerte automate≈ºe pentru v√¢nt puternic √Æn Bucure»ôti. AboneazƒÉ-te pentru notificƒÉri push gratuite.">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .hero {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            text-align: center;
            padding: 60px 30px;
            position: relative;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="white" opacity="0.1"/><circle cx="80" cy="40" r="1.5" fill="white" opacity="0.15"/><circle cx="40" cy="70" r="1" fill="white" opacity="0.2"/><circle cx="90" cy="80" r="1.5" fill="white" opacity="0.1"/><circle cx="10" cy="90" r="1" fill="white" opacity="0.15"/></svg>');
        }

        .hero h1 {
            font-size: 3rem;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }

        .hero p {
            font-size: 1.3rem;
            opacity: 0.9;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }

        .notification-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .notification-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .notification-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .content {
            padding: 50px 30px;
        }

        .status-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #3498db;
        }

        .status-card.success {
            border-left-color: #27ae60;
            background: #d5f4e6;
        }

        .status-card.warning {
            border-left-color: #f39c12;
            background: #fef9e7;
        }

        .status-card.error {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }

        .weather-info {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
        }

        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .weather-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .weather-item .value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .weather-item .label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .feature {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .feature h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .feature p {
            color: #7f8c8d;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .alert.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert.info {
            background: #cce7ff;
            border: 1px solid #b3d9ff;
            color: #0056b3;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 600px) {
            .container {
                margin: 10px;
            }
            
            .hero {
                padding: 40px 20px;
            }
            
            .hero h1 {
                font-size: 2.2rem;
            }
            
            .content {
                padding: 30px 20px;
            }
            
            .weather-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .footer {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            color: #6c757d;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="hero">
            <h1>üå™Ô∏è Wind Warning</h1>
            <p>Alerte automate≈ºe pentru v√¢nt puternic √Æn Bucure»ôti</p>
            <button id="subscribeBtn" class="notification-btn">
                üîî AboneazƒÉ-te la Alerte
            </button>
        </div>

        <div class="content">
            <div class="alert" id="alertBox"></div>

            <div class="status-card" id="statusCard">
                <h3>üì± Status NotificƒÉri</h3>
                <p id="statusText">ApasƒÉ butonul de mai sus pentru a te abona la alertele automate≈ºe de v√¢nt.</p>
            </div>

            <div class="weather-info" id="weatherInfo" style="display: none;">
                <h3>üå§Ô∏è Condi»õii Meteo Actuale</h3>
                <div class="weather-grid" id="weatherGrid">
                    <!-- Weather data will be inserted here -->
                </div>
                <p style="margin-top: 15px; opacity: 0.8; font-size: 0.9rem;" id="weatherTime">
                    Actualizat: <span id="lastUpdate">-</span>
                </p>
            </div>

            <div class="features">
                <div class="feature">
                    <div class="feature-icon">‚ö°</div>
                    <h3>Instant & Automat</h3>
                    <p>Prime»ôti alertƒÉ imediat c√¢nd v√¢ntul depƒÉ»ôe»ôte 25 km/h √Æn Bucure»ôti. FƒÉrƒÉ formulare sau setƒÉri complicate.</p>
                </div>

                <div class="feature">
                    <div class="feature-icon">üéØ</div>
                    <h3>Localizat</h3>
                    <p>MonitorizƒÉm specific zona Bucure»ôti pentru informa»õii meteo precise »ôi relevante.</p>
                </div>

                <div class="feature">
                    <div class="feature-icon">üîí</div>
                    <h3>Privat & Sigur</h3>
                    <p>Nu colectƒÉm date personale. NotificƒÉrile sunt trimise direct √Æn browser-ul tƒÉu.</p>
                </div>

                <div class="feature">
                    <div class="feature-icon">üì±</div>
                    <h3>Cross-Platform</h3>
                    <p>Func»õioneazƒÉ pe toate dispozitivele: desktop, mobile, tablet. FƒÉrƒÉ aplica»õii de instalat.</p>
                </div>
            </div>

            <div class="status-card warning">
                <h3>‚ö†Ô∏è Important</h3>
                <p>Aceste alerte sunt informative. Pentru situa»õii de urgen»õƒÉ sau decizii critice, consultƒÉ surse oficiale de prognozƒÉ meteo.</p>
            </div>
        </div>

        <div class="footer">
            <p>Wind Warning System &copy; 2025 | Alimentat de OpenWeatherMap & OneSignal</p>
        </div>
    </div>

    <script>
        const subscribeBtn = document.getElementById('subscribeBtn');
        const alertBox = document.getElementById('alertBox');
        const statusCard = document.getElementById('statusCard');
        const statusText = document.getElementById('statusText');
        const weatherInfo = document.getElementById('weatherInfo');
        const weatherGrid = document.getElementById('weatherGrid');
        const lastUpdateSpan = document.getElementById('lastUpdate');

        // Service Worker for push notifications
        let swRegistration = null;

        function showAlert(message, type = 'info') {
            alertBox.textContent = message;
            alertBox.className = `alert ${type}`;
            alertBox.style.display = 'block';
            
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 8000);
        }

        function updateStatus(message, type = '') {
            statusText.textContent = message;
            statusCard.className = `status-card ${type}`;
        }

        function setButtonState(text, disabled = false) {
            subscribeBtn.textContent = text;
            subscribeBtn.disabled = disabled;
        }

        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    // Create a simple service worker inline
                    const swCode = `
                        self.addEventListener('push', function(event) {
                            const options = {
                                body: event.data ? event.data.text() : 'AlertƒÉ nouƒÉ de v√¢nt!',
                                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="%233498db"/><text x="50" y="60" text-anchor="middle" fill="white" font-size="30">üå™Ô∏è</text></svg>',
                                badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="%23e74c3c"/><text x="50" y="60" text-anchor="middle" fill="white" font-size="20">!</text></svg>',
                                tag: 'wind-alert',
                                requireInteraction: true
                            };
                            
                            event.waitUntil(
                                self.registration.showNotification('üå™Ô∏è Wind Warning', options)
                            );
                        });
                        
                        self.addEventListener('notificationclick', function(event) {
                            event.notification.close();
                            event.waitUntil(
                                clients.openWindow('/')
                            );
                        });
                    `;
                    
                    const swBlob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(swBlob);
                    
                    swRegistration = await navigator.serviceWorker.register(swUrl);
                    console.log('‚úÖ Service Worker registered');
                    return swRegistration;
                } catch (error) {
                    console.error('‚ùå Service Worker registration failed:', error);
                    throw error;
                }
            } else {
                throw new Error('Service Workers not supported');
            }
        }

        async function subscribeToNotifications() {
            try {
                setButtonState('‚è≥ Se aboneazƒÉ...', true);
                
                // Check if notifications are supported
                if (!('Notification' in window)) {
                    throw new Error('NotificƒÉrile nu sunt suportate √Æn acest browser');
                }

                // Register service worker
                if (!swRegistration) {
                    swRegistration = await registerServiceWorker();
                }

                // Request notification permission
                let permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    throw new Error('Permisiunea pentru notificƒÉri a fost refuzatƒÉ');
                }

                // Subscribe to push notifications
                const subscription = await swRegistration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array('BOwJmBQ5C84P27ZeEbFFfu6zbCPnItDkTn5dmKL2DVSOEO6nnRxhTYIs-nE6WnX84_W-INsV91renCCx7LeOwhQ')
                });

                // Auto-register user with default settings
                const userData = {
                    push_subscription: subscription,
                    wind_threshold: 25, // Default threshold
                    location: 'Bucure»ôti, Rom√¢nia',
                    push_enabled: true,
                    email_enabled: false,
                    sms_enabled: false,
                    alert_frequency: 'immediate'
                };

                // Send subscription to server
                const response = await fetch('/.netlify/functions/subscribe-notifications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('‚úÖ Te-ai abonat cu succes! Vei primi alerte c√¢nd v√¢ntul depƒÉ»ôe»ôte 25 km/h.', 'success');
                    updateStatus('üéâ Abonat cu succes! Vei primi alerte automate≈æe pentru v√¢nt > 25 km/h.', 'success');
                    setButtonState('‚úÖ Abonat la Alerte');
                    
                    // Load current weather
                    loadWeatherData();
                } else {
                    throw new Error(result.error || 'Eroare la abonare');
                }

            } catch (error) {
                console.error('Subscription error:', error);
                showAlert(`‚ùå Eroare la abonare: ${error.message}`, 'error');
                updateStatus('‚ùå Abonarea a e»ôuat. √éncearcƒÉ din nou.', 'error');
                setButtonState('üîî √éncearcƒÉ din nou');
            }
        }

        async function loadWeatherData() {
            try {
                const response = await fetch('/.netlify/functions/get-weather');
                const result = await response.json();
                
                if (result.success) {
                    const weather = result.weather;
                    
                    weatherGrid.innerHTML = `
                        <div class="weather-item">
                            <div class="value">${weather.wind_speed}</div>
                            <div class="label">km/h v√¢nt</div>
                        </div>
                        <div class="weather-item">
                            <div class="value">${weather.wind_gust}</div>
                            <div class="label">km/h rafale</div>
                        </div>
                        <div class="weather-item">
                            <div class="value">${weather.temperature}¬∞</div>
                            <div class="label">Temperatura</div>
                        </div>
                        <div class="weather-item">
                            <div class="value">${weather.humidity}%</div>
                            <div class="label">Umiditate</div>
                        </div>
                    `;
                    
                    lastUpdateSpan.textContent = new Date().toLocaleString('ro-RO');
                    weatherInfo.style.display = 'block';
                    
                    // Check if wind is high
                    if (weather.wind_speed >= 25) {
                        showAlert(`üå™Ô∏è Aten»õie! V√¢ntul actual (${weather.wind_speed} km/h) depƒÉ»ôe»ôte pragul de alertƒÉ.`, 'warning');
                    }
                }
            } catch (error) {
                console.error('Weather load error:', error);
            }
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // Initialize
        subscribeBtn.addEventListener('click', subscribeToNotifications);

        // Check if already subscribed
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(registration => {
                return registration.pushManager.getSubscription();
            }).then(subscription => {
                if (subscription) {
                    updateStatus('üéâ Deja abonat la alerte! Vei primi notificƒÉri pentru v√¢nt > 25 km/h.', 'success');
                    setButtonState('‚úÖ Deja Abonat');
                    loadWeatherData();
                }
            });
        }

        // Load weather on page load
        setTimeout(loadWeatherData, 1000);
    </script>
</body>
</html>